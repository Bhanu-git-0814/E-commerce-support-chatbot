<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My AI Studio</title>
    <style>
        /* --- MODERN STYLES --- */
        :root {
            --primary-color: #1976D2; /* Blue 700 */
            --primary-color-light: #64B5F6; /* Blue 300 */
            --primary-color-dark: #0D47A1; /* Blue 900 */
            --accent-color: #4CAF50; /* Green 500 */
            
            --background-main: #ECEFF1; /* Blue Grey 50 */
            --background-card: #FFFFFF;
            --background-input: #F5F7FA; /* Lighter than main, for inputs */
            --background-hover: #E3F2FD; /* Blue 50 */
            --background-active-nav: #BBDEFB; /* Blue 100 */

            --text-primary: #263238; /* Blue Grey 900 */
            --text-secondary: #546E7A; /* Blue Grey 600 */
            --text-light: #FFFFFF;
            --text-on-primary-active: var(--primary-color);

            --border-color: #CFD8DC; /* Blue Grey 100 */
            --border-color-strong: #B0BEC5; /* Blue Grey 200 */
            --border-focus: var(--primary-color);

            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.16);
            --shadow-md: 0 3px 6px rgba(0,0,0,0.12), 0 3px 6px rgba(0,0,0,0.20);
            --font-family: 'Roboto', 'Noto Sans', sans-serif;
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 18px; /* For chat bubbles/pills */
            --transition-speed: 0.2s ease;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #B0BEC5; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #90A4AE; 
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            background-color: var(--background-main);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* Left Sidebar */
        .left-sidebar {
            width: 250px; 
            background-color: var(--background-card);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            transition: width var(--transition-speed);
        }

        .left-sidebar .logo {
            font-size: 1.6em; 
            font-weight: 700; 
            color: var(--primary-color);
            margin-bottom: 30px;
            padding: 10px 0;
            text-align: center; 
        }

        .left-sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .left-sidebar nav li {
            padding: 12px 16px; 
            margin-bottom: 8px; 
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500; 
            display: flex;
            align-items: center;
            white-space: nowrap;
            color: var(--text-secondary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }
        .left-sidebar nav li .icon {
            margin-right: 16px; 
            font-size: 1.3em; 
            min-width: 24px; 
            text-align: center;
        }

        .left-sidebar nav li:hover {
            background-color: var(--background-hover);
            color: var(--primary-color);
        }

        .left-sidebar nav li.active {
            background-color: var(--background-active-nav);
            color: var(--text-on-primary-active);
            font-weight: 600;
        }
        .left-sidebar nav li.active .icon {
             color: var(--primary-color);
        }

        .history-panel {
            padding-top: 16px;
            flex-grow: 1;
            overflow-y: auto;
            display: none;
            margin-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        .history-panel h4 {
            margin-top: 0;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--text-primary);
            padding: 0 8px; 
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .history-item {
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.88em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }
        .history-item:hover {
            background-color: var(--background-hover);
        }
        .history-item.selected-history {
            background-color: var(--background-active-nav);
            border-color: var(--primary-color-light);
            color: var(--text-on-primary-active);
        }
        .history-item-name {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-item-delete {
            background: none;
            border: none;
            color: #E57373; 
            font-size: 1.1em; 
            padding: 2px 4px;
            cursor: pointer;
            opacity: 0.7;
            margin-left: 8px;
            transition: opacity var(--transition-speed), color var(--transition-speed);
        }
        .history-item-delete:hover {
            opacity: 1;
            color: #D32F2F; 
        }

        /* Main Content */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--background-main); 
            padding: 0; 
            overflow-y: auto;
        }
        .main-content.hidden-view { display: none; }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px; 
            border-bottom: 1px solid var(--border-color);
            background-color: var(--background-card); 
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100; 
        }

        .main-header h2 {
            margin: 0;
            font-size: 1.35em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .main-header-actions .icon-btn, #clear-backend-history-btn {
            background: none;
            border: none;
            font-size: 1.4em; 
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            margin-left: 12px;
            border-radius: 50%; 
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }
        #clear-backend-history-btn { 
            font-size: 0.85em;
            padding: 8px 16px;
            border-radius: var(--border-radius-lg);
            background-color: var(--background-input);
            border: 1px solid var(--border-color);
            font-weight: 500;
        }
        #clear-backend-history-btn:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .main-header-actions .icon-btn:hover:not(:disabled) {
            background-color: var(--background-hover);
            color: var(--primary-color);
        }
        .main-header-actions .icon-btn:disabled {
            color: var(--border-color-strong);
            cursor: not-allowed;
        }
        .main-header-actions .icon-btn:disabled:hover {
            background-color: transparent;
        }

        .chat-interface {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 24px; 
        }

        #chat-output {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0; 
            display: flex;
            flex-direction: column;
            margin-bottom: 20px; 
        }
        .welcome-message {
            text-align: center;
            margin: auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: var(--text-secondary);
        }
        .welcome-message h1 {
            font-size: 2.8em;
            font-weight: 300; 
            color: var(--primary-color);
            margin-bottom: 16px;
        }
         .welcome-message p { 
            font-size: 1.1em;
            max-width: 500px;
            line-height: 1.6;
        }

        .message-block {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px; 
            max-width: 75%;
        }
        .message-block.user-block {
            align-self: flex-end;
            margin-left: auto;
        }
        .message-block.ai-block {
            align-self: flex-start;
            margin-right: auto;
        }

        .message {
            padding: 12px 18px;
            border-radius: var(--border-radius-lg); 
            /* margin-bottom removed, handled by message-block */
            /* max-width removed, handled by message-block */
            word-wrap: break-word;
            line-height: 1.6;
            white-space: pre-wrap;
            box-shadow: var(--shadow-sm);
            transition: transform 0.1s ease-out; 
            position: relative; /* For absolute positioning of delete button */
        }
        .message:hover {
            transform: translateY(-1px);
        }

        .message.user {
            background-color: var(--primary-color);
            color: var(--text-light);
            /* align-self removed, handled by message-block */
            /* margin-left removed, handled by message-block */
            border-bottom-right-radius: var(--border-radius-sm); 
        }
        .message.ai {
            background-color: var(--background-card);
            color: var(--text-primary);
            /* align-self removed, handled by message-block */
            /* margin-right removed, handled by message-block */
            border: 1px solid var(--border-color);
            border-bottom-left-radius: var(--border-radius-sm); 
        }
        .message.error { /* Error messages might not be in a block, style independently */
            background-color: #FFCDD2; 
            color: #D32F2F; 
            align-self: center;
            text-align: center;
            max-width: 90%;
            border: 1px solid #E57373; 
        }
         .message.error .message-delete-btn { display: none; } /* No delete for errors for now */

        .message.loading { /* Loading messages are simple, not in a block usually */
            font-style: italic;
            color: var(--text-secondary);
            align-self: flex-start;
            background-color: transparent;
            box-shadow: none;
            border: none;
        }
         .message.loading .message-delete-btn { display: none; }


        .message-delete-btn {
            position: absolute;
            top: -8px; 
            right: -8px; 
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 14px;
            font-weight: bold;
            line-height: 20px; 
            text-align: center;
            cursor: pointer;
            opacity: 0; 
            transition: opacity 0.2s ease, background-color 0.2s ease;
            z-index: 5; 
            color: var(--text-secondary);
        }
        .message:hover .message-delete-btn {
            opacity: 1;
        }
        .message-delete-btn:hover {
            background: #e9ecef;
            color: #dc3545; /* Red for delete action */
        }


        .message.ai .cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em;
            background-color: var(--text-primary);
            animation: blink 1s step-end infinite;
            margin-left: 3px;
            vertical-align: text-bottom;
        }
        @keyframes blink { 50% { opacity: 0; } }

        .message-model-name {
            font-size: 0.75em; 
            color: var(--text-secondary); 
            margin-top: 6px; 
            padding-left: 4px; /* Slight indent if needed */
            /* text-align: left; is default for block */
        }
        .message-block.user-block .message-model-name {
            display: none; /* Should not be there anyway, but defensive */
        }


        .system-prompt-container {
            margin: 0 auto 16px auto;
            max-width: 800px;
            width: 100%;
        }

        #system-prompt-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-size: 0.95em;
            line-height: 1.5;
            min-height: 60px;
            max-height: 150px;
            resize: vertical;
            box-sizing: border-box;
            background-color: var(--background-input);
            color: var(--text-primary);
            font-family: inherit;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        #system-prompt-input::placeholder { color: var(--text-secondary); opacity: 0.7; }
        #system-prompt-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2); 
            background-color: var(--background-card);
        }

        .prompt-suggestions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .suggestion-btn {
            background-color: var(--background-card);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: var(--border-radius-lg); 
            cursor: pointer;
            font-size: 0.85em;
            color: var(--text-secondary);
            font-weight: 500;
            transition: background-color var(--transition-speed), color var(--transition-speed), box-shadow var(--transition-speed);
        }
        .suggestion-btn:hover {
            background-color: var(--background-hover);
            color: var(--primary-color);
            border-color: var(--primary-color-light);
            box-shadow: var(--shadow-sm);
        }

        .prompt-input-area {
            display: flex;
            align-items: flex-end; 
            border: 1px solid var(--border-color-strong);
            border-radius: var(--border-radius-lg); 
            padding: 8px 8px 8px 16px; 
            background-color: var(--background-card);
            margin: 0 auto;
            max-width: 800px;
            width: 100%;
            box-shadow: var(--shadow-md);
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        .prompt-input-area:focus-within {
            border-color: var(--border-focus);
            box-shadow: var(--shadow-md), 0 0 0 2px rgba(25, 118, 210, 0.2);
        }

        #prompt-input {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 10px 0; 
            font-size: 1em;
            resize: none;
            background-color: transparent;
            min-height: 24px; 
            max-height: 150px; 
            overflow-y: auto;
            color: var(--text-primary);
            line-height: 1.5; 
        }
        #prompt-input::placeholder { color: var(--text-secondary); opacity: 0.7; }

        #run-button {
            background-color: var(--primary-color);
            color: var(--text-light);
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-md); 
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            margin-left: 10px;
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
            box-shadow: var(--shadow-sm);
        }
        #run-button .shortcut { font-size: 0.8em; opacity: 0.8; margin-left: 5px; }
        #run-button:hover:not(:disabled) {
            background-color: var(--primary-color-dark);
            box-shadow: var(--shadow-md);
        }
        #run-button:disabled {
            background-color: var(--primary-color-light);
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }

        /* Right Sidebar */
        .right-sidebar {
            width: 320px; 
            background-color: var(--background-card);
            padding: 20px;
            border-left: 1px solid var(--border-color);
            overflow-y: auto;
            font-size: 0.9em;
            box-shadow: var(--shadow-sm);
            transition: width var(--transition-speed);
        }
        .right-sidebar.hidden-view { display: none; }

        .right-sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        .right-sidebar-header h3 {
            margin: 0;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.15em;
        }
        .icon-btn-sm {
            background: none;
            border: none;
            font-size: 1.3em;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }
        .icon-btn-sm:hover:not(:disabled) {
            background-color: var(--background-hover);
            color: var(--primary-color);
        }
        .icon-btn-sm:disabled { color: var(--border-color-strong); cursor: not-allowed; }
        .icon-btn-sm:disabled:hover { background-color: transparent; }

        .settings-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }
        .settings-section:last-child { border-bottom: none; padding-bottom: 0; }
        
        #model-select, #temperature-value {
            width: 100%;
            padding: 10px 12px;
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color-strong);
            background-color: var(--background-input);
            font-size: 0.9em;
            color: var(--text-primary);
            box-sizing: border-box; 
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        #model-select:focus, #temperature-value:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
            background-color: var(--background-card);
        }

        .model-info-text {
            font-size: 0.8em; 
            color: var(--text-secondary);
            padding: 10px;
            margin-top: 8px; 
            margin-bottom: 16px;
            line-height: 1.5;
            background-color: var(--background-input);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        .setting-item:last-child { margin-bottom: 0; }
        .setting-item label {
            color: var(--text-secondary);
            font-weight: 500;
            margin-right: 10px; 
        }
        #temperature { 
            flex-grow: 1;
            margin: 0 10px;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            outline: none;
        }
        #temperature::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--background-card); 
            box-shadow: var(--shadow-sm);
        }
        #temperature::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--background-card);
            box-shadow: var(--shadow-sm);
        }
        #temperature-value {
            width: 60px; 
            padding: 8px;
            text-align: center;
            margin-left: 0; 
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="left-sidebar">
            <div class="logo" id="app-logo">My AI Studio</div>
            <nav>
                <ul>
                    <li class="active" id="nav-chat"><span class="icon">💬</span> Chat</li>
                    <li id="nav-history"><span class="icon">📜</span> History</li>
                    <li id="nav-stt"><span class="icon">🎤</span> Speech-to-Text</li>
                    <li id="nav-tts"><span class="icon">🗣️</span> Text-to-Speech</li>
                </ul>
            </nav>
            <div class="history-panel" id="history-panel-display">
                <h4>Chat History (Local)</h4>
                <ul id="history-list"></ul>
            </div>
        </aside>

        <main class="main-content" id="main-chat-content">
            <header class="main-header">
                 <h2 id="chat-prompt-header">Chat Prompt</h2>
                <div class="main-header-actions">
                    <button class="icon-btn" id="new-chat-btn" title="New Chat (Ctrl+N)">📄</button>
                    <button class="icon-btn" id="clear-chat-content-btn" title="Clear Current Chat Content (keeps history entry)">🗑️</button>
                    <button id="clear-backend-history-btn" title="Clear current backend session memory">Clear Memory</button>
                </div>
            </header>

            <div class="chat-interface">
                <div id="chat-output">
                    <div class="welcome-message">
                        <h1 id="welcome-header">Welcome to My AI Studio</h1>
                        <p>Start a conversation, explore AI capabilities, or load a previous chat from the history.</p>
                    </div>
                </div>
                <div class="system-prompt-container">
                    <textarea id="system-prompt-input" placeholder="System Prompt (e.g., You are a poetic assistant that responds in rhyme.)"></textarea>
                </div>
                <div class="prompt-suggestions">
                    <button class="suggestion-btn">Explain quantum computing in simple terms.</button>
                    <button class="suggestion-btn">Write a short poem about the moon.</button>
                    <button class="suggestion-btn">What is the capital of France?</button>
                </div>
                <div class="prompt-input-area">
                    <textarea id="prompt-input" placeholder="User prompt... (Press Enter to send)"></textarea>
                    <button id="run-button">Run <span class="shortcut">↵</span></button>
                </div>
            </div>
        </main>

        <aside class="right-sidebar" id="right-settings-sidebar">
            <div class="right-sidebar-header">
                <h3>Run settings</h3>
                <div class="actions">
                    <button class="icon-btn-sm" id="reset-settings-btn" title="Reset Settings">🔄</button>
                </div>
            </div>
            <div class="settings-section">
                <select id="model-select"></select>
                <div id="model-info" class="model-info-text">Select a model to see its rate limits and context window.</div>
                <div class="setting-item">
                    <span>Context Window</span>
                    <span id="token-count">-- tokens</span>
                </div>
                <div class="setting-item">
                    <label for="temperature">Temperature</label>
                    <input type="range" id="temperature" name="temperature" min="0" max="1" step="0.1" value="0.7">
                    <input type="number" id="temperature-value" value="0.7" min="0" max="1" step="0.1">
                </div>
            </div>
        </aside>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- APP CONFIG ---
            const APP_NAME = "My AI Studio";
            const DEFAULT_MODEL_ID = "llama3-8b-8192";
            const DEFAULT_TEMPERATURE = 0.7;
            const CHAT_HISTORY_KEY = 'aiStudioChatHistory'; 
            const CHAT_HISTORY_INDEX_KEY = 'aiStudioChatHistoryIndex'; 

            // --- DOM Elements ---
            const appLogo = document.getElementById('app-logo');
            const welcomeHeader = document.getElementById('welcome-header');
            const promptInput = document.getElementById('prompt-input');
            const systemPromptInput = document.getElementById('system-prompt-input');
            const runButton = document.getElementById('run-button');
            const chatOutput = document.getElementById('chat-output');
            const temperatureSlider = document.getElementById('temperature');
            const temperatureValue = document.getElementById('temperature-value');
            const modelSelect = document.getElementById('model-select');
            const modelInfoDiv = document.getElementById('model-info');
            const tokenCountSpan = document.getElementById('token-count');
            const welcomeMessageContainer = document.querySelector('.welcome-message');
            const suggestionButtons = document.querySelectorAll('.suggestion-btn');
            const newChatBtn = document.getElementById('new-chat-btn');
            const clearChatContentBtn = document.getElementById('clear-chat-content-btn');
            const clearBackendHistoryBtn = document.getElementById('clear-backend-history-btn');
            const resetSettingsBtn = document.getElementById('reset-settings-btn');
            const navChat = document.getElementById('nav-chat');
            const navHistory = document.getElementById('nav-history');
            const navSTT = document.getElementById('nav-stt');
            const navTTS = document.getElementById('nav-tts');
            const historyPanelDisplay = document.getElementById('history-panel-display');
            const historyListUL = document.getElementById('history-list');
            const mainChatContent = document.getElementById('main-chat-content');
            const rightSettingsSidebar = document.getElementById('right-settings-sidebar');
            const chatPromptHeader = document.getElementById('chat-prompt-header');

            const API_CHAT_URL = '/chat';
            const API_CREATE_SESSION_URL = '/create-session';
            const API_CLEAR_HISTORY_URL = '/clear-backend-history';

            const modelsData = [ 
                { id: "allam-2-7b", group: "Chat", name: "Allam 2 (7B)", rpm: 30, rpd: 7000, tpm: 6000, tpd: "(No limit)", contextWindow: 8192 },
                { id: "compound-beta", group: "Chat", name: "Compound Beta", rpm: 15, rpd: 200, tpm: 70000, tpd: "(No limit)", contextWindow: 8192 },
                { id: "compound-beta-mini", group: "Chat", name: "Compound Beta Mini", rpm: 15, rpd: 200, tpm: 70000, tpd: "(No limit)", contextWindow: 8192 },
                { id: "deepseek-r1-distill-llama-70b", group: "Chat", name: "DeepSeek R1 Distill Llama (70B)", rpm: 30, rpd: 1000, tpm: 6000, tpd: "(No limit)", contextWindow: 8192 },
                { id: "gemma2-9b-it", group: "Chat", name: "Gemma 2 (9B Instruct)", rpm: 30, rpd: 14400, tpm: 15000, tpd: "500,000", contextWindow: 8192 },
                { id: "llama-3.1-8b-instant", group: "Chat", name: "Llama 3.1 (8B Instant)", rpm: 30, rpd: 14400, tpm: 6000, tpd: "500,000", contextWindow: 8192 },
                { id: "llama-3.3-70b-versatile", group: "Chat", name: "Llama 3.3 (70B Versatile)", rpm: 30, rpd: 1000, tpm: 12000, tpd: "100,000", contextWindow: 8192 },
                { id: "llama-guard-3-8b", group: "Chat", name: "Llama Guard 3 (8B)", rpm: 30, rpd: 14400, tpm: 15000, tpd: "500,000", contextWindow: 8192 },
                { id: "llama3-70b-8192", group: "Chat", name: "Llama 3 (70B)", rpm: 30, rpd: 14400, tpm: 6000, tpd: "500,000", contextWindow: 8192 },
                { id: "llama3-8b-8192", group: "Chat", name: "Llama 3 (8B)", rpm: 30, rpd: 14400, tpm: 6000, tpd: "500,000", contextWindow: 8192 },
                { id: "meta-llama/llama-4-maverick-17b-128e-instruct", group: "Chat", name: "Llama 4 Maverick (17B 128e)", rpm: 30, rpd: 1000, tpm: 6000, tpd: "(No limit)", contextWindow: 128000 },
                { id: "meta-llama/llama-4-scout-17b-16e-instruct", group: "Chat", name: "Llama 4 Scout (17B 16e)", rpm: 30, rpd: 1000, tpm: 30000, tpd: "(No limit)", contextWindow: 16000 },
                { id: "mistral-saba-24b", group: "Chat", name: "Mistral Saba (24B)", rpm: 30, rpd: 1000, tpm: 6000, tpd: "500,000", contextWindow: 8192 },
                { id: "qwen-qwq-32b", group: "Chat", name: "Qwen QWQ (32B)", rpm: 30, rpd: 1000, tpm: 6000, tpd: "(No limit)", contextWindow: 8192 },
                { id: "distil-whisper-large-v3-en", group: "STT", name: "DistilWhisper Large v3 (EN)", rpm: 20, rpd: 2000, tpm: 7200, tpd: "28,800" },
                { id: "whisper-large-v3", group: "STT", name: "Whisper Large v3", rpm: 20, rpd: 2000, tpm: 7200, tpd: "28,800" },
                { id: "whisper-large-v3-turbo", group: "STT", name: "Whisper Large v3 Turbo", rpm: 20, rpd: 2000, tpm: 7200, tpd: "28,800" },
                { id: "playai-tts", group: "TTS", name: "PlayAI TTS", rpm: 10, rpd: 100, tpm: 1200, tpd: "3,600" },
                { id: "playai-tts-arabic", group: "TTS", name: "PlayAI TTS (Arabic)", rpm: 10, rpd: 100, tpm: 1200, tpd: "3,600" }
            ];
            const chatModels = modelsData.filter(model => model.group === "Chat");
            
            let currentChatSession = createNewFrontendChatObject(); 
            let chatHistoryIndex = []; 
            let currentBackendSessionId = null; 

            function generateMessageId() {
                return `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            }

            // --- Initialization ---
            function initializeApp() {
                if (appLogo) appLogo.textContent = APP_NAME;
                if (welcomeHeader) welcomeHeader.innerHTML = `Welcome to ${APP_NAME}`; 
                
                loadChatHistoryIndex(); 
                populateModelDropdown();
                resetSettingsToDefault();
                
                createNewBackendSession(() => {
                    startNewFrontendChatSession(); 
                    promptInput.focus();
                });
            }

            // --- Backend Session Management ---
            async function createNewBackendSession(callback) {
                try {
                    const response = await fetch(API_CREATE_SESSION_URL, { method: 'POST' });
                    const data = await response.json();
                    if (data.status === 'success' && data.session_id) {
                        currentBackendSessionId = data.session_id;
                        console.log("New backend session created:", currentBackendSessionId);
                        if (callback) callback();
                    } else {
                        console.error("Failed to create backend session:", data.message);
                        addMessageToChatDOM({text: `Error: Could not start a new backend session. ${data.message || ''}`, sender: 'ai', type: 'error'});
                    }
                } catch (error) {
                    console.error("Error calling /create-session:", error);
                     addMessageToChatDOM({text: `Error: Network issue creating backend session. ${error.message}`, sender: 'ai', type: 'error'});
                }
            }

            async function clearCurrentBackendHistory() {
                if (!currentBackendSessionId) {
                    alert("No active backend session to clear.");
                    return;
                }
                if (!confirm("This will clear the AI's memory for the current conversation on the server. Local display will remain. Continue?")) {
                    return;
                }
                try {
                    const response = await fetch(API_CLEAR_HISTORY_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ session_id: currentBackendSessionId })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        alert(data.message || "Backend session memory cleared.");
                        console.log("Backend history cleared for session:", currentBackendSessionId);
                    } else {
                        alert(`Failed to clear backend history: ${data.message}`);
                    }
                } catch (error) {
                    console.error("Error calling /clear-backend-history:", error);
                    alert(`Network error clearing backend history: ${error.message}`);
                }
            }

            // --- Frontend Chat Session & Local History Management ---
            function createNewFrontendChatObject(id = `chat-${Date.now()}`) {
                return {
                    id: id, 
                    name: `Chat ${new Date().toLocaleString()}`,
                    systemPrompt: systemPromptInput.value || '',
                    model: modelSelect.value || DEFAULT_MODEL_ID,
                    temperature: parseFloat(temperatureSlider.value) || DEFAULT_TEMPERATURE,
                    messages: [], 
                    timestamp: Date.now()
                };
            }

            function startNewFrontendChatSession(loadDefaults = true) {
                currentChatSession = createNewFrontendChatObject(); 
                if (loadDefaults) {
                    systemPromptInput.value = ''; 
                    currentChatSession.systemPrompt = '';
                    resetSettingsToDefault(); 
                }
                chatOutput.innerHTML = ''; 
                renderWelcomeMessage();
                promptInput.value = '';
                adjustTextareaHeight(promptInput);
                adjustTextareaHeight(systemPromptInput);
                updateChatPromptHeader();
                createNewBackendSession(() => {
                    console.log("New frontend chat started, associated with new backend session:", currentBackendSessionId);
                    promptInput.focus();
                });
            }

            function saveCurrentFrontendChatSession() { 
                if (!currentChatSession || !currentChatSession.id) return;
                
                const isExistingInHistory = chatHistoryIndex.some(entry => entry.id === currentChatSession.id);
                if (currentChatSession.messages.length === 0 && !currentChatSession.systemPrompt.trim() && !isExistingInHistory) {
                     console.log("Skipping save for new, entirely empty chat session:", currentChatSession.id);
                     return;
                }

                currentChatSession.systemPrompt = systemPromptInput.value;
                currentChatSession.model = modelSelect.value; // Overall session model, individual messages might vary if setting changes
                currentChatSession.temperature = parseFloat(temperatureSlider.value);
                // currentChatSession.timestamp = Date.now(); // Update timestamp on every save

                // Name derivation logic
                if (currentChatSession.name.startsWith("Chat ") || currentChatSession.messages.length === 0) {
                    if (currentChatSession.messages.length > 0) {
                        const firstUserMessage = currentChatSession.messages.find(m => m.sender === 'user');
                        if (firstUserMessage && firstUserMessage.text) {
                           currentChatSession.name = firstUserMessage.text.substring(0, 30) + (firstUserMessage.text.length > 30 ? '...' : '');
                        } else { // No user message or empty, use generic
                            currentChatSession.name = `Chat ${new Date(currentChatSession.timestamp).toLocaleString()}`;
                        }
                    } else { // No messages, use generic
                        currentChatSession.name = `Chat ${new Date(currentChatSession.timestamp).toLocaleString()}`;
                    }
                }
                // If name was manually set (doesn't start with "Chat ") and there are still messages, keep it.

                localStorage.setItem(currentChatSession.id, JSON.stringify(currentChatSession));
                
                const indexEntry = chatHistoryIndex.find(entry => entry.id === currentChatSession.id);
                if (indexEntry) {
                    if(indexEntry.name !== currentChatSession.name) indexEntry.name = currentChatSession.name;
                    // indexEntry.timestamp = currentChatSession.timestamp; // Already updated if name changed
                } else {
                    chatHistoryIndex.push({ 
                        id: currentChatSession.id, 
                        name: currentChatSession.name,
                        timestamp: currentChatSession.timestamp 
                    });
                }
                chatHistoryIndex.sort((a, b) => b.timestamp - a.timestamp); 
                localStorage.setItem(CHAT_HISTORY_INDEX_KEY, JSON.stringify(chatHistoryIndex));
                renderHistoryList(); 
                updateChatPromptHeader();
                console.log("Frontend chat session saved to localStorage:", currentChatSession.id);
            }

            function loadChatHistoryIndex() { 
                const storedIndex = localStorage.getItem(CHAT_HISTORY_INDEX_KEY);
                if (storedIndex) {
                    chatHistoryIndex = JSON.parse(storedIndex);
                    chatHistoryIndex.sort((a, b) => b.timestamp - a.timestamp);
                } else {
                    chatHistoryIndex = [];
                }
                renderHistoryList();
            }

            function loadFrontendChatSession(frontendSessionId) { 
                const sessionData = localStorage.getItem(frontendSessionId);
                if (sessionData) {
                    currentChatSession = JSON.parse(sessionData); 
                    systemPromptInput.value = currentChatSession.systemPrompt || ''; 
                    modelSelect.value = currentChatSession.model || DEFAULT_MODEL_ID;
                    updateTemperatureUI(currentChatSession.temperature || DEFAULT_TEMPERATURE);
                    updateModelInfo(modelSelect.value); 

                    chatOutput.innerHTML = ''; 
                    if (currentChatSession.messages && currentChatSession.messages.length > 0) {
                        hideWelcomeMessage();
                        currentChatSession.messages.forEach(msg => {
                            // Ensure older messages without IDs get one for DOM keying, but don't save it back to the object
                            const msgToRender = {...msg};
                            if (!msgToRender.id) msgToRender.id = generateMessageId(); // Temporary for rendering
                            addMessageToChatDOM(msgToRender); 
                        });
                    } else {
                        renderWelcomeMessage();
                    }
                    
                    adjustTextareaHeight(systemPromptInput);
                    switchToChatView(); 
                    updateChatPromptHeader();
                    
                    createNewBackendSession(() => {
                        console.log("Loaded frontend chat session:", frontendSessionId, "Associated with new backend session:", currentBackendSessionId);
                        promptInput.focus();
                    });
                }
            }
            
            function deleteFrontendChatSession(frontendSessionId, event) { 
                event.stopPropagation(); 
                const chatToDelete = chatHistoryIndex.find(s => s.id === frontendSessionId);
                if (!confirm(`Are you sure you want to delete local chat: ${chatToDelete?.name || frontendSessionId}? This does not affect server memory of past sessions.`)) {
                    return;
                }
                localStorage.removeItem(frontendSessionId);
                chatHistoryIndex = chatHistoryIndex.filter(entry => entry.id !== frontendSessionId);
                localStorage.setItem(CHAT_HISTORY_INDEX_KEY, JSON.stringify(chatHistoryIndex));
                renderHistoryList();

                if (currentChatSession && currentChatSession.id === frontendSessionId) {
                    startNewFrontendChatSession(); 
                }
                console.log("Deleted frontend chat session from localStorage:", frontendSessionId);
            }

            function renderHistoryList() { 
                historyListUL.innerHTML = '';
                chatHistoryIndex.forEach(entry => {
                    const li = document.createElement('li');
                    li.classList.add('history-item');
                    li.dataset.sessionId = entry.id; 
                    if (currentChatSession && entry.id === currentChatSession.id) {
                        li.classList.add('selected-history');
                    }

                    const nameSpan = document.createElement('span');
                    nameSpan.classList.add('history-item-name');
                    nameSpan.textContent = entry.name || `Chat ${new Date(entry.timestamp).toLocaleDateString()}`;
                    li.appendChild(nameSpan);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('history-item-delete');
                    deleteBtn.innerHTML = '×'; 
                    deleteBtn.title = "Delete local chat";
                    deleteBtn.onclick = (event) => deleteFrontendChatSession(entry.id, event);
                    li.appendChild(deleteBtn);
                    
                    li.onclick = () => {
                         document.querySelectorAll('.history-item.selected-history').forEach(item => item.classList.remove('selected-history'));
                         li.classList.add('selected-history');
                         loadFrontendChatSession(entry.id); 
                    }
                    historyListUL.appendChild(li);
                });
            }
            
            function updateChatPromptHeader() {
                 if (currentChatSession && currentChatSession.name) {
                     chatPromptHeader.textContent = currentChatSession.name;
                 } else {
                     chatPromptHeader.textContent = "Chat Prompt";
                 }
            }

            function populateModelDropdown() {
                if (!modelSelect) return;
                modelSelect.innerHTML = '';
                chatModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name || model.id;
                    modelSelect.appendChild(option);
                });
            }

            function getModelDisplayName(modelId) {
                const model = modelsData.find(m => m.id === modelId);
                return model ? model.name : modelId;
            }

            function updateModelInfo(modelId) {
                if (!modelInfoDiv || !tokenCountSpan) return;
                const model = modelsData.find(m => m.id === modelId);
                if (model) {
                    modelInfoDiv.innerHTML = `RPM: ${model.rpm} | RPD: ${model.rpd} <br>TPM: ${model.tpm} | TPD: ${model.tpd}`;
                    if (model.group === "Chat" && model.contextWindow) {
                        tokenCountSpan.textContent = `${model.contextWindow.toLocaleString()} tokens`;
                    } else {
                        tokenCountSpan.textContent = "-- tokens"; 
                    }
                } else {
                    modelInfoDiv.textContent = 'Model info not available.';
                    tokenCountSpan.textContent = "-- tokens";
                }
            }
            function updateTemperatureUI(value) {
                temperatureSlider.value = value;
                temperatureValue.value = parseFloat(value).toFixed(1);
            }
            function resetSettingsToDefault() {
                modelSelect.value = DEFAULT_MODEL_ID;
                selectedModelId = DEFAULT_MODEL_ID; 
                updateModelInfo(DEFAULT_MODEL_ID); 
                updateTemperatureUI(DEFAULT_TEMPERATURE);
            }
            function renderWelcomeMessage() {
                if (welcomeMessageContainer) {
                    welcomeMessageContainer.style.display = 'flex';
                }
            }
            function hideWelcomeMessage() {
                if (welcomeMessageContainer) welcomeMessageContainer.style.display = 'none';
            }
            function adjustTextareaHeight(textarea) {
                if (textarea) {
                    textarea.style.height = 'auto';
                    setTimeout(() => {
                        textarea.style.height = (textarea.scrollHeight) + 'px';
                    }, 0);
                }
            }

            [promptInput, systemPromptInput].forEach(textarea => {
                if (textarea) {
                    textarea.addEventListener('input', () => adjustTextareaHeight(textarea));
                    adjustTextareaHeight(textarea); 
                }
            });
            temperatureSlider.addEventListener('input', (e) => updateTemperatureUI(e.target.value));
            temperatureValue.addEventListener('input', (e) => {
                let val = parseFloat(e.target.value);
                if (isNaN(val)) val = DEFAULT_TEMPERATURE;
                if (val < 0) val = 0; if (val > 1) val = 1;
                updateTemperatureUI(val);
            });

            let selectedModelId = DEFAULT_MODEL_ID; 
            if (modelSelect) {
                modelSelect.addEventListener('change', (event) => {
                    selectedModelId = event.target.value;
                    updateModelInfo(selectedModelId);
                });
            }

            function handleDeleteMessage(messageId) {
                if (!currentChatSession || !currentChatSession.messages) return;
                
                const msgIndex = currentChatSession.messages.findIndex(m => m.id === messageId);
                if (msgIndex === -1) {
                    console.warn("Attempted to delete message not found in session:", messageId);
                    return;
                }

                if (confirm("Are you sure you want to delete this message? This action is only on the frontend.")) {
                    currentChatSession.messages.splice(msgIndex, 1);
                    
                    const msgElement = document.querySelector(`.message-block[data-message-id="${messageId}"]`);
                    if (msgElement) {
                        msgElement.remove();
                    }

                    if (currentChatSession.messages.length === 0 && !currentChatSession.systemPrompt.trim()) {
                        renderWelcomeMessage();
                    }
                    saveCurrentFrontendChatSession(); // This will persist the change and update name if needed
                }
            }


            function addMessageToChatDOM(messageObject) {
                const { id, text, sender, model, type = 'text', isStreaming = false } = messageObject;
                const msgIdForDOM = id || generateMessageId(); // Use provided ID or generate one for DOM

                // Handle special non-block messages first
                if (sender === 'ai' && type === 'error') {
                     hideWelcomeMessage();
                     const errorDiv = document.createElement('div');
                     errorDiv.classList.add('message', 'ai', 'error'); // Simpler structure for direct errors
                     errorDiv.textContent = text;
                     chatOutput.appendChild(errorDiv);
                     chatOutput.scrollTop = chatOutput.scrollHeight;
                     return errorDiv; // Return the div for potential updates if needed (though usually not for errors)
                }
                 if (sender === 'ai' && type === 'system') { // For system notifications like "New session started"
                     hideWelcomeMessage();
                     const systemMsgDiv = document.createElement('div');
                     systemMsgDiv.classList.add('message', 'ai', 'loading'); // Style like loading for now
                     systemMsgDiv.textContent = text;
                     chatOutput.appendChild(systemMsgDiv);
                     chatOutput.scrollTop = chatOutput.scrollHeight;
                     return systemMsgDiv;
                }


                hideWelcomeMessage();
                const messageBlockDiv = document.createElement('div');
                messageBlockDiv.classList.add('message-block');
                messageBlockDiv.dataset.messageId = msgIdForDOM;

                if (sender === 'user') {
                    messageBlockDiv.classList.add('user-block');
                } else {
                    messageBlockDiv.classList.add('ai-block');
                }

                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', sender);
                // Type 'error' handled above for AI, user errors not expected here

                const contentSpan = document.createElement('span');
                contentSpan.textContent = text; 
                messageDiv.appendChild(contentSpan);

                // Add delete button only if original message object had an ID (i.e., it's a persisted message)
                if (id) { 
                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('message-delete-btn');
                    deleteBtn.innerHTML = '×'; // Using '×' (multiplication sign)
                    deleteBtn.title = 'Delete message';
                    deleteBtn.onclick = (event) => {
                        event.stopPropagation(); 
                        handleDeleteMessage(id); // Use the original, persistent ID
                    };
                    messageDiv.appendChild(deleteBtn);
                }

                if (isStreaming && sender === 'ai') {
                    const cursorSpan = document.createElement('span');
                    cursorSpan.classList.add('cursor');
                    messageDiv.appendChild(cursorSpan);
                    messageDiv.dataset.streaming = "true"; 
                }
                
                messageBlockDiv.appendChild(messageDiv);

                if (sender === 'ai' && model) { // Add model name if AI message and model is specified
                    const modelNameDiv = document.createElement('div');
                    modelNameDiv.classList.add('message-model-name');
                    modelNameDiv.textContent = `Model: ${getModelDisplayName(model)}`;
                    messageBlockDiv.appendChild(modelNameDiv);
                }
                
                chatOutput.appendChild(messageBlockDiv);
                chatOutput.scrollTop = chatOutput.scrollHeight;
                return messageDiv; // Return the inner messageDiv for streaming updates to contentSpan
            }


            function updateStreamingMessage(aiMessageDiv, chunk) {
                // aiMessageDiv is the .message.ai div returned by addMessageToChatDOM
                if (aiMessageDiv && aiMessageDiv.dataset.streaming === "true") {
                    const contentSpan = aiMessageDiv.querySelector('span:not(.cursor)');
                    if (contentSpan) {
                        contentSpan.textContent += chunk;
                        chatOutput.scrollTop = chatOutput.scrollHeight;
                    }
                }
            }
            function finalizeStreamingMessage(aiMessageDiv) {
                // aiMessageDiv is the .message.ai div
                if (aiMessageDiv && aiMessageDiv.dataset.streaming === "true") {
                    const cursor = aiMessageDiv.querySelector('.cursor');
                    if (cursor) cursor.remove();
                    delete aiMessageDiv.dataset.streaming;
                    // Model name is already added by addMessageToChatDOM
                }
            }

            const handleRunPrompt = async () => {
                if (!currentBackendSessionId) {
                    addMessageToChatDOM({ text: "Error: No active backend session. Please try creating a new chat or reloading.", sender: 'ai', type: 'error'});
                    await createNewBackendSession(() => {
                        if(currentBackendSessionId) {
                             addMessageToChatDOM({text: "New backend session started. Please try your prompt again.", sender: 'ai', type: 'system'}); 
                        }
                    });
                    return;
                }

                const userPromptText = promptInput.value.trim();
                if (!userPromptText) {
                    promptInput.focus();
                    return;
                }

                const userMessageId = generateMessageId();
                const userMessageObj = { id: userMessageId, sender: 'user', text: userPromptText };
                addMessageToChatDOM(userMessageObj);
                currentChatSession.messages.push(userMessageObj);
                // Name update is now handled in saveCurrentFrontendChatSession
                
                promptInput.value = '';
                adjustTextareaHeight(promptInput);
                runButton.disabled = true;

                const currentModelId = modelSelect.value; 
                const aiMessageId = generateMessageId();
                let aiMessageDiv = addMessageToChatDOM({ id: aiMessageId, text: "", sender: 'ai', model: currentModelId, isStreaming: true }); 
                let fullAiResponseText = "";

                const payload = {
                    session_id: currentBackendSessionId, 
                    prompt: userPromptText,
                    system_prompt: systemPromptInput.value.trim(),
                    temperature: parseFloat(temperatureSlider.value),
                    model_id: currentModelId,
                };
                
                try {
                    const response = await fetch(API_CHAT_URL, { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        finalizeStreamingMessage(aiMessageDiv);
                        const contentSpan = aiMessageDiv.querySelector('span:not(.cursor)');
                        // Remove the placeholder AI message block if it's empty before showing error
                        if (aiMessageDiv.parentElement && (!contentSpan || !contentSpan.textContent.trim())) {
                            aiMessageDiv.parentElement.remove(); 
                        }
                        const errorData = await response.json().catch(() => ({error: "Server error occurred."}));
                        addMessageToChatDOM({ text: errorData.error || `HTTP error! status: ${response.status}`, sender: 'ai', type: 'error'});
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        
                        const sseLines = decoder.decode(value, { stream: true }).split('\n\n');
                        for (const line of sseLines) {
                            if (line.startsWith('data:')) {
                                try {
                                    const jsonData = JSON.parse(line.substring(5).trim());
                                    if (jsonData.error) {
                                        console.error("Stream error from backend:", jsonData.error);
                                        fullAiResponseText += `\n[Error: ${jsonData.error}]`; 
                                        updateStreamingMessage(aiMessageDiv, `\n[Error: ${jsonData.error}]`);
                                        if(jsonData.is_final) break; 
                                    } else if (jsonData.text_chunk) {
                                        fullAiResponseText += jsonData.text_chunk;
                                        updateStreamingMessage(aiMessageDiv, jsonData.text_chunk);
                                    }
                                    if (jsonData.is_final) {
                                        if(jsonData.full_response){ 
                                            fullAiResponseText = jsonData.full_response;
                                            const contentSpan = aiMessageDiv.querySelector('span:not(.cursor)');
                                            if(contentSpan) contentSpan.textContent = fullAiResponseText;
                                        }
                                        finalizeStreamingMessage(aiMessageDiv);
                                        currentChatSession.messages.push({ id: aiMessageId, sender: 'ai', text: fullAiResponseText, model: currentModelId });
                                        saveCurrentFrontendChatSession(); 
                                        break; 
                                    }
                                } catch (e) {
                                    console.warn("Error parsing SSE JSON:", e, "Line:", line);
                                }
                            }
                        }
                         if (document.querySelector('.message[data-streaming="true"]') === null) break; 
                    }

                } catch (error) {
                    console.error('Fetch/Stream Error:', error);
                    finalizeStreamingMessage(aiMessageDiv);
                    const contentSpan = aiMessageDiv ? aiMessageDiv.querySelector('span:not(.cursor)') : null;
                    if (aiMessageDiv && aiMessageDiv.parentElement && (!contentSpan || !contentSpan.textContent.trim())) {
                        aiMessageDiv.parentElement.remove();
                        addMessageToChatDOM({text: `Error: ${error.message}`, sender: 'ai', type: 'error'});
                    } else if (aiMessageDiv) { 
                         // aiMessageDiv.classList.add('error'); // The block itself is not an error
                         updateStreamingMessage(aiMessageDiv, `\n[Error: ${error.message}]`);
                         // Mark the content as error visually if needed, or rely on error being appended.
                    }
                    currentChatSession.messages.push({ id: aiMessageId, sender: 'ai', text: `Error: ${error.message}`, model: currentModelId }); 
                    saveCurrentFrontendChatSession(); 
                } finally {
                    runButton.disabled = false;
                    promptInput.focus();
                }
            };

            function handleClearChatContent() {
                if (!currentChatSession || (currentChatSession.messages.length === 0 && currentChatSession.systemPrompt.trim() === '')) {
                    return;
                }

                if (confirm("Are you sure you want to clear all messages and the system prompt for the current chat? The chat will remain in your history list, but its content will be emptied.")) {
                    currentChatSession.messages = [];
                    currentChatSession.systemPrompt = '';
                    if (systemPromptInput) {
                        systemPromptInput.value = '';
                        adjustTextareaHeight(systemPromptInput);
                    }
                    
                    // Name will be reset by saveCurrentFrontendChatSession if it was generic or chat is empty
                    currentChatSession.timestamp = Date.now(); // Update timestamp to reflect this "modification"

                    chatOutput.innerHTML = ''; 
                    renderWelcomeMessage();    
                    
                    saveCurrentFrontendChatSession(); // Persists cleared state and updates name/history list
                    
                    promptInput.focus();
                }
            }


            function switchToChatView() {
                mainChatContent.classList.remove('hidden-view');
                rightSettingsSidebar.classList.remove('hidden-view');
                historyPanelDisplay.style.display = 'none';
                promptInput.focus();
                renderHistoryList(); 
            }

            function switchToHistoryView() {
                mainChatContent.classList.add('hidden-view');
                rightSettingsSidebar.classList.add('hidden-view');
                historyPanelDisplay.style.display = 'block';
                renderHistoryList(); 
            }

            function handleNavClick(navItem) {
                document.querySelectorAll('.left-sidebar nav li.active').forEach(li => li.classList.remove('active'));
                navItem.classList.add('active');
                
                if (navItem.id === 'nav-chat') {
                    switchToChatView();
                } else if (navItem.id === 'nav-history') {
                    switchToHistoryView();
                } else {
                    let featureName = navItem.textContent.replace(/<span class="icon">.*?<\/span>/i, '').trim();
                    alert(`The "${featureName}" interface would load here. (Coming Soon)`);
                    switchToChatView(); 
                    navChat.classList.add('active'); 
                    navItem.classList.remove('active'); 
                }
            }

            if (newChatBtn) newChatBtn.addEventListener('click', () => startNewFrontendChatSession());
            if (clearChatContentBtn) clearChatContentBtn.addEventListener('click', handleClearChatContent);
            if (clearBackendHistoryBtn) clearBackendHistoryBtn.addEventListener('click', clearCurrentBackendHistory);
            if (resetSettingsBtn) resetSettingsBtn.addEventListener('click', () => { resetSettingsToDefault(); promptInput.focus(); });
            if (runButton) runButton.addEventListener('click', handleRunPrompt);
            
            promptInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    handleRunPrompt();
                } else if (event.ctrlKey && event.key === 'n') { 
                    event.preventDefault();
                    startNewFrontendChatSession();
                }
            });

            suggestionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    promptInput.value = button.textContent;
                    adjustTextareaHeight(promptInput);
                    promptInput.focus();
                    handleRunPrompt();
                });
            });
            
            [navChat, navHistory, navSTT, navTTS].forEach(navItem => {
                if (navItem) {
                    navItem.addEventListener('click', () => handleNavClick(navItem));
                }
            });

            initializeApp();
        });
    </script>
</body>
</html>